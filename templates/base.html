{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Web3.AI{% endblock %} | Enterprise Agents</title>
    
    <!-- FONTS: Inter & JetBrains Mono -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- ETHERS.JS (Required for Wallet & x402) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <!-- MARKED.JS (For Markdown Rendering) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- CORE STYLES -->
    <style>
        /* ════════════════════════════════════════════════════════════════════════
           DESIGN SYSTEM - Minimal Monochrome
           ════════════════════════════════════════════════════════════════════════ */
        :root {
            /* Colors */
            --bg-body: #050505;
            --bg-panel: #0F0F0F;
            --bg-card: #141414;
            --bg-hover: #1F1F1F;
            
            --border-light: #222222;
            --border-hover: #444444;
            
            --text-main: #FFFFFF;
            --text-muted: #888888;
            --text-dim: #555555;
            
            /* Dimensions & Spacing */
            --sidebar-width-open: 260px;
            --sidebar-width-closed: 70px;
            --header-height: 60px;
        }

        /* ════════════════════════════════════════════════════════════════════════
           RESET & TYPOGRAPHY
           ════════════════════════════════════════════════════════════════════════ */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
        }

        /* Hide Scrollbar but keep scrolling */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        a { text-decoration: none; color: inherit; transition: 0.2s; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }

        /* Typography Utilities */
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .text-xs { font-size: 11px; }
        .text-sm { font-size: 13px; }
        .text-lg { font-size: 18px; }
        .text-xl { font-size: 24px; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .text-muted { color: var(--text-muted); }
        .uppercase { text-transform: uppercase; }
        .tracking-wide { letter-spacing: 0.05em; }

        /* ════════════════════════════════════════════════════════════════════════
           SIDEBAR COMPONENT
           ════════════════════════════════════════════════════════════════════════ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width-open);
            background: var(--bg-panel);
            border-right: 1px solid var(--border-light);
            z-index: 50;
            transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
        }

        /* Collapsed State Logic */
        .sidebar.collapsed {
            width: var(--sidebar-width-closed);
            overflow-x: hidden;
        }

        /* Toggle Button */
        .toggle-btn {
            position: absolute;
            right: -12px;
            top: 24px;
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            z-index: 60;
            cursor: pointer;
            transition: 0.2s;
        }
        .toggle-btn:hover { background: var(--text-main); color: var(--bg-body); }
        .toggle-btn svg { width: 14px; height: 14px; transition: 0.3s; }
        .sidebar.collapsed .toggle-btn svg { transform: rotate(180deg); }

        /* Branding */
        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-light);
            transition: 0.2s;
        }
        .brand-logo {
            min-width: 32px;
            height: 32px;
            background: var(--text-main);
            color: var(--bg-body);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            margin-right: 12px;
        }
        .brand-text {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            opacity: 1;
            transition: 0.2s;
        }
        .sidebar.collapsed .brand-text { opacity: 0; pointer-events: none; }

        /* Navigation Links */
        .nav-menu {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
        }
        
        .nav-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            padding: 0 12px;
            margin-bottom: 8px;
            white-space: nowrap;
            transition: 0.2s;
        }
        .sidebar.collapsed .nav-header { opacity: 0; }

        .nav-item {
            display: flex;
            align-items: center;
            height: 44px;
            padding: 0 12px;
            border-radius: 8px;
            color: var(--text-muted);
            margin-bottom: 4px;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-main);
        }
        
        .nav-item.active {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-light);
        }
        
        .nav-icon {
            min-width: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .nav-label {
            white-space: nowrap;
            opacity: 1;
            transition: 0.2s;
            font-weight: 500;
        }
        
        .sidebar.collapsed .nav-label { opacity: 0; }
        
        /* Nav Badge (Price) */
        .nav-badge {
            margin-left: auto;
            font-size: 10px;
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 4px;
            color: var(--text-dim);
            transition: 0.2s;
        }
        .sidebar.collapsed .nav-badge { opacity: 0; }

        /* Wallet Section (Bottom) */
        .wallet-panel {
            padding: 16px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-panel);
        }
        .wallet-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            transition: 0.2s;
            overflow: hidden;
        }
        .wallet-icon-box {
            min-width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #111;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: #2ecc71; /* Accent for connected state */
        }
        .wallet-info {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
            opacity: 1;
            transition: 0.2s;
        }
        .sidebar.collapsed .wallet-info { opacity: 0; }
        
        /* ════════════════════════════════════════════════════════════════════════
           MAIN CONTENT
           ════════════════════════════════════════════════════════════════════════ */
        .main-wrapper {
            flex: 1;
            margin-left: var(--sidebar-width-open);
            background: var(--bg-body);
            transition: margin-left 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            min-height: 100vh;
        }
        .sidebar.collapsed + .main-wrapper {
            margin-left: var(--sidebar-width-closed);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        /* ════════════════════════════════════════════════════════════════════════
           COMPONENTS (Buttons, Cards, Forms)
           ════════════════════════════════════════════════════════════════════════ */
        /* Glass Panel / Card */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 24px;
            transition: 0.2s;
        }
        .panel:hover {
            border-color: var(--border-hover);
        }

        /* Button Primary */
        .btn-primary {
            background: var(--text-main);
            color: var(--bg-body);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-primary:active { transform: translateY(0); }

        /* Button Ghost */
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-ghost:hover {
            background: var(--bg-hover);
            border-color: var(--text-main);
        }

        /* Form Input */
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .input-field {
            width: 100%;
            background: var(--bg-body);
            border: 1px solid var(--border-light);
            color: var(--text-main);
            padding: 14px 16px;
            border-radius: 8px;
            font-family: inherit;
            transition: 0.2s;
        }
        .input-field:focus {
            border-color: var(--text-main);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(5,5,5,0.8);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #FFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-wrapper { margin-left: 0 !important; }
            .toggle-btn { display: none; } /* Hide regular toggle on mobile */
            
            /* Mobile Header Trigger */
            .mobile-trigger {
                display: flex !important;
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 40;
                background: var(--bg-panel);
                border: 1px solid var(--border-light);
                padding: 8px;
                border-radius: 6px;
            }
        }
        .mobile-trigger { display: none; }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- ═══════════════════════════════════════════════════════════════════════
         LOADING OVERLAY
         ═══════════════════════════════════════════════════════════════════════ -->
    <div id="loader">
        <div class="spinner"></div>
        <p class="font-mono text-sm mt-4 text-muted" id="loader-text">Processing...</p>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════
         MOBILE MENU TRIGGER
         ═══════════════════════════════════════════════════════════════════════ -->
    <button class="mobile-trigger" onclick="toggleSidebar()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SIDEBAR NAVIGATION
         ═══════════════════════════════════════════════════════════════════════ -->
    <aside class="sidebar" id="sidebar">
        <!-- Collapse Button -->
        <button class="toggle-btn" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>

        <!-- Brand -->
        <div class="brand">
            <div class="brand-logo">AI</div>
            <div class="brand-text">Web3.AI</div>
        </div>

        <!-- Links -->
        <nav class="nav-menu">
            <div class="nav-header">Platform</div>
            
            <a href="{% url 'dashboard' %}" class="nav-item {% block nav_dashboard %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></div>
                <span class="nav-label">Dashboard</span>
            </a>

            <div class="nav-header" style="margin-top: 16px;">AI Agents</div>
            
            <!-- GitHub Agent -->
            <a href="{% url 'agent_github' %}" class="nav-item {% block nav_github %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></div>
                <span class="nav-label">GitHub Architect</span>
                <span class="nav-badge font-mono">0.0005</span>
            </a>

            <!-- Voice Agent -->
            <a href="{% url 'agent_audio' %}" class="nav-item {% block nav_audio %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></div>
                <span class="nav-label">Voice Intelligence</span>
                <span class="nav-badge font-mono">0.0011</span>
            </a>
            
            <!-- CompeteScan -->
            <a href="{% url 'agent_competescan' %}" class="nav-item {% block nav_competescan %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                <span class="nav-label">CompeteScan AI</span>
                <span class="nav-badge font-mono">0.0010</span>
            </a>
            

            
            <!-- YT Docs -->
            <a href="{% url 'ytdocs_view' %}" class="nav-item {% block nav_ytdocs %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                <span class="nav-label">YT Docs Agent</span>
                <span class="nav-badge font-mono">0.00001</span>
            </a>
            
            <!-- Model Intelligence Lab -->
            <a href="{% url 'model_lab' %}" class="nav-item {% block nav_modellab %}{% endblock %}">
                <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div>
                <span class="nav-label">Model Lab</span>
                <span class="nav-badge font-mono">0.0002</span>
            </a>
            
            <div class="nav-header" style="margin-top: 16px;">System</div>
            
            <!-- History -->
            <a href="{% url 'history_view' %}" class="nav-item {% block nav_history %}{% endblock %}">
                 <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <span class="nav-label">History & Stats</span>
            </a>
            
            <!-- PayLink Agent -->
            <a href="{% url 'profile' %}" class="nav-item {% block nav_paylink %}{% endblock %}">
                 <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg></div>
                <span class="nav-label">PayLink System</span>
            </a>

            <!-- Logout -->
            <a href="{% url 'logout' %}" class="nav-item">
                 <div class="nav-icon"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></div>
                <span class="nav-label">Disconnect</span>
            </a>
        </nav>

        <!-- Wallet Info -->
        <div class="wallet-panel">
            <div class="wallet-card">
                <div class="wallet-icon-box">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h14c1.1 0 2 .9 2 2v1h-9a2 2 0 00-2 2v8a2 2 0 002 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                </div>
                <div class="wallet-info">
                    <div class="font-mono text-xs text-muted">{{ user.wallet_address|truncatechars:12 }}</div>
                    <div class="font-bold text-sm" id="walletBalance">-- MON</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ═══════════════════════════════════════════════════════════════════════
         MAIN CONTENT WRAPPER
         ═══════════════════════════════════════════════════════════════════════ -->
    <main class="main-wrapper">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- ═══════════════════════════════════════════════════════════════════════
         x402 PROTOCOL & GLOBAL JS
         ═══════════════════════════════════════════════════════════════════════ -->
    <script>
        // -------------------------------------------------------------
        // UI INTERACTIONS
        // -------------------------------------------------------------
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            // Check if mobile or desktop
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
            } else {
                sidebar.classList.toggle('collapsed');
                // Save preference
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            }
        }

        // Restore sidebar state
        window.addEventListener('load', () => {
            if (localStorage.getItem('sidebarCollapsed') === 'true' && window.innerWidth > 768) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        });

        // Loader
        function showLoader(text = "Processing...") {
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loader').style.display = 'flex';
        }
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // -------------------------------------------------------------
        // WALLET UTILS
        // -------------------------------------------------------------
        async function fetchBalance() {
            if (window.ethereum) {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    const address = await signer.getAddress();
                    const balance = await provider.getBalance(address);
                    document.getElementById('walletBalance').innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + " MON";
                } catch(e) {
                    console.log("Wallet not connected for balance");
                }
            }
        }
        fetchBalance();

        // -------------------------------------------------------------
        // x402 PROTOCOL LOGIC (Global Module)
        // -------------------------------------------------------------
        window.x402 = {
            MONAD_CHAIN_ID: '0x279f', // 10143
            MONAD_RPC: 'https://testnet-rpc.monad.xyz',
            
            // CSRF Helper
            getCSRFToken: () => {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') return value;
                }
                return '';
            },

            // Ensure Network
            ensureNetwork: async () => {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: window.x402.MONAD_CHAIN_ID }],
                    });
                } catch (switchError) {
                    // This error code 4902 indicates that the chain has not been added to MetaMask.
                    // Also check message for robustness
                    if (switchError.code === 4902 || (switchError.message && switchError.message.includes("Unrecognized"))) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: window.x402.MONAD_CHAIN_ID,
                                    chainName: 'Monad Testnet',
                                    rpcUrls: [window.x402.MONAD_RPC],
                                    nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
                                    blockExplorerUrls: ["https://testnet.monadexplorer.com/"]
                                }],
                            });
                        } catch (addError) {
                            console.error("Failed to add chain", addError);
                            alert("Could not add Monad Testnet automatically. Please add Chain ID 10143 manually.");
                        }
                    } else {
                        console.error("Switch Chain Error", switchError);
                        // Fallback: Try adding anyway if code is unknown but suspicious?
                        // For now just alert if it's not user rejection (4001)
                        if (switchError.code !== 4001) {
                             alert("Network Switch Error: " + switchError.message);
                        }
                    }
                }
            },

            // Standard x402 Fetch
            fetch: async (url, options = {}) => {
                showLoader("Initiating Request...");
                
                // Add CSRF
                options.headers = options.headers || {};
                options.headers['X-CSRFToken'] = window.x402.getCSRFToken();

                try {
                    // 1. Initial Call
                    let res = await fetch(url, options);

                    // 2. Check 402
                    if (res.status === 402) {
                        const data = await res.json();
                        const reqs = data.paymentRequirements;
                        
                        showLoader(`Payment Required: ${reqs.amount} MON`);
                        
                        await window.x402.ensureNetwork();
                        
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        const signer = provider.getSigner();
                        
                        // Send Tx
                        const tx = await signer.sendTransaction({
                            to: reqs.payTo,
                            value: ethers.utils.parseEther(reqs.amount)
                        });
                        
                        showLoader("Verifying on Blockchain...");
                        await tx.wait();
                        
                        // 3. Retry with Header
                        options.headers['x-payment'] = tx.hash;
                        res = await fetch(url, options);
                    }
                    
                    return res;
                } catch (e) {
                    console.error(e);
                    alert("x402 Error: " + e.message);
                    throw e;
                } finally {
                    hideLoader();
                }
            },
            
            // FormData x402 Fetch (for Audio/File Uploads)
            fetchFormData: async (url, formData) => {
                showLoader("Uploading & Initiating...");
                
                try {
                    let res = await fetch(url, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': window.x402.getCSRFToken() },
                        body: formData
                    });

                    if (res.status === 402) {
                        const data = await res.json();
                        const reqs = data.paymentRequirements;

                        showLoader(`Payment Required: ${reqs.amount} MON`);
                        await window.x402.ensureNetwork();
                        
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        const signer = provider.getSigner();
                        
                        const tx = await signer.sendTransaction({
                            to: reqs.payTo,
                            value: ethers.utils.parseEther(reqs.amount)
                        });
                        
                        showLoader("Verifying on Blockchain...");
                        await tx.wait();
                        
                        res = await fetch(url, {
                            method: 'POST',
                            headers: { 
                                'X-CSRFToken': window.x402.getCSRFToken(),
                                'x-payment': tx.hash 
                            },
                            body: formData
                        });
                    }
                    return res;
                } catch (e) {
                    console.error(e);
                    alert("x402 Error: " + e.message);
                    throw e;
                } finally {
                    hideLoader();
                }
            }
        };

        // Expose globally
        window.x402Fetch = window.x402.fetch;
        window.x402FetchFormData = window.x402.fetchFormData;
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
