<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Web3 AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .nav-item.active { background-color: #EEF2FF; color: #4F46E5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col justify-between hidden md:flex z-10">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
                <span class="text-xl font-bold tracking-tight">Web3 AI</span>
            </div>

            <nav class="space-y-1">
                <button onclick="switchView('home')" id="nav-home" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50 transition active">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    New Analysis
                </button>
                <button onclick="switchView('history')" id="nav-history" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    History & Analytics
                </button>
                <button onclick="window.location.href='/logout/'" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-red-600 hover:bg-red-50 transition mt-8">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </nav>
        </div>
        
        <div class="p-6 border-t border-slate-100">
            <div class="bg-indigo-50 rounded-xl p-4">
                <p class="text-xs font-semibold text-indigo-900 uppercase mb-1">Wallet</p>
                <p class="text-xs text-indigo-700 break-all font-mono mb-2">{{ user.wallet_address }}</p>
                <div class="flex items-center justify-between">
                    <span id="balanceDisplay" class="text-sm font-bold text-indigo-700">-- ETH</span>
                    <div class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- Header Mobile -->
        <header class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center">
             <span class="text-xl font-bold">Web3 AI</span>
             <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="p-2 text-slate-600">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
             </button>
        </header>

        <!-- Content Views -->
        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative scroll-smooth">
            
            <!-- VIEW: HOME (Agent Selection) -->
            <div id="view-home" class="max-w-5xl mx-auto animate-fade-in">
                <header class="mb-12 text-center">
                    <h1 class="text-4xl font-bold text-slate-900 mb-4 tracking-tight">Select Intelligence type</h1>
                    <p class="text-lg text-slate-500 max-w-2xl mx-auto">Choose a specialized AI agent to process your data. Secure payments via Sepolia ETH.</p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    
                    <!-- GitHub Card -->
                    <div onclick="openGithubForm()" class="group bg-white p-8 rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-indigo-200 cursor-pointer transition-all duration-300 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg class="w-32 h-32 text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </div>
                        <div class="relative z-10">
                            <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-3xl mb-6">üêô</div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2 group-hover:text-indigo-600 transition">GitHub Agent</h3>
                            <p class="text-slate-500 mb-6 font-medium">Deep analysis of repositories, PRs, and Issues.</p>
                            <ul class="space-y-2 text-sm text-slate-400 mb-8">
                                <li class="flex items-center gap-2">‚úì Repo Summarizer</li>
                                <li class="flex items-center gap-2">‚úì Architecture Map</li>
                                <li class="flex items-center gap-2">‚úì PR Reviewer</li>
                            </ul>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">0.001 ETH</span>
                                <span class="text-indigo-600 font-semibold group-hover:translate-x-1 transition flex items-center gap-1">Select <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></span>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Card -->
                    <div onclick="openAudioForm()" class="group bg-white p-8 rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-violet-200 cursor-pointer transition-all duration-300 relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <svg class="w-32 h-32 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </div>
                        <div class="relative z-10">
                            <div class="w-14 h-14 bg-violet-100 rounded-2xl flex items-center justify-center text-3xl mb-6">üéôÔ∏è</div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2 group-hover:text-violet-600 transition">Audio Analyst</h3>
                            <p class="text-slate-500 mb-6 font-medium">Transcribe & Extract Action Items from records.</p>
                            <ul class="space-y-2 text-sm text-slate-400 mb-8">
                                <li class="flex items-center gap-2">‚úì High-Accuracy Transcription</li>
                                <li class="flex items-center gap-2">‚úì Minutes of Meeting</li>
                                <li class="flex items-center gap-2">‚úì Deadline Extraction</li>
                            </ul>
                            <div class="flex items-center justify-between mt-auto">
                                <span class="bg-violet-50 text-violet-700 px-3 py-1 rounded-full text-xs font-bold">0.001 ETH</span>
                                <span class="text-violet-600 font-semibold group-hover:translate-x-1 transition flex items-center gap-1">Select <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: GITHUB FORM -->
            <div id="view-github" class="max-w-3xl mx-auto hidden animate-fade-in py-10">
                <button onclick="switchView('home')" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-slate-600 transition text-sm">
                    ‚Üê Back to selection
                </button>
                
                <h2 class="text-3xl font-bold text-slate-900 mb-8 flex items-center gap-3">
                    <span class="text-indigo-600 text-4xl">üêô</span> GitHub Analysis
                </h2>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Repository URL</label>
                    <input type="text" id="repoUrlInput" placeholder="https://github.com/owner/repo" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 mb-6 outline-none transition">

                    <label class="block text-sm font-medium text-slate-700 mb-2">Analysis Type</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                        <button onclick="selectGhType(this, 'summary')" class="gh-type-btn active px-4 py-3 rounded-xl border border-indigo-500 bg-indigo-50 text-indigo-700 text-sm font-bold text-center transition">Summarizer</button>
                        <button onclick="selectGhType(this, 'architecture')" class="gh-type-btn px-4 py-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium text-center transition">Architecture</button>
                        <button onclick="selectGhType(this, 'issues')" class="gh-type-btn px-4 py-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium text-center transition">Issues</button>
                        <button onclick="selectGhType(this, 'pr_review')" class="gh-type-btn px-4 py-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium text-center transition">PR Review</button>
                    </div>

                    <button id="btn-run-github" onclick="runGithubAgent()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-indigo-500/30 transition flex items-center justify-center gap-2">
                        <span>Pay 0.001 ETH & Run</span>
                    </button>
                </div>
            </div>

            <!-- VIEW: AUDIO FORM -->
            <div id="view-audio" class="max-w-3xl mx-auto hidden animate-fade-in py-10">
                <button onclick="switchView('home')" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-slate-600 transition text-sm">
                    ‚Üê Back to selection
                </button>
                
                <h2 class="text-3xl font-bold text-slate-900 mb-8 flex items-center gap-3">
                    <span class="text-violet-600 text-4xl">üéôÔ∏è</span> Audio Intelligence
                </h2>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                    <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl p-10 text-center hover:bg-slate-50 transition cursor-pointer mb-6">
                        <input type="file" id="audioFileInput" class="hidden" accept="audio/*">
                        <div class="w-16 h-16 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚òÅÔ∏è</div>
                        <h4 class="text-lg font-bold text-slate-800 mb-1">Click to upload audio</h4>
                        <p class="text-sm text-slate-500">MP3, WAV, M4A up to 25MB</p>
                        <p id="file-name-display" class="mt-4 text-violet-600 font-bold hidden"></p>
                    </div>

                    <button id="btn-run-audio" onclick="runAudioAgent()" class="w-full py-4 bg-violet-600 hover:bg-violet-700 text-white font-bold rounded-xl shadow-lg hover:shadow-violet-500/30 transition flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>
                        <span>Pay 0.001 ETH & Transcribe</span>
                    </button>
                </div>
            </div>

            <!-- LOADING OVERLAY -->
            <div id="loading-overlay" class="absolute inset-0 bg-white/90 z-50 hidden flex flex-col items-center justify-center">
                <div class="w-24 h-24 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
                <h3 id="loading-text" class="text-2xl font-bold text-slate-800 animate-pulse">Processing...</h3>
                <p id="loading-sub" class="text-slate-500 mt-2">Please wait while we interact with the blockchain & AI.</p>
            </div>

            <!-- VIEW: RESULTS -->
            <div id="view-results" class="max-w-4xl mx-auto hidden animate-fade-in py-10">
                 <button onclick="switchView('home')" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-slate-600 transition text-sm">
                    ‚Üê New Analysis
                </button>
                
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-900 px-8 py-6 flex justify-between items-center text-white">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-green-400">‚óè</span> Analysis Complete
                        </h2>
                        <button class="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-1 rounded uppercase tracking-wider">Export JSON</button>
                    </div>
                    <div id="results-container" class="p-8 prose prose-indigo max-w-none">
                        <!-- Content injected JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: HISTORY & ANALYTICS -->
            <div id="view-history" class="max-w-6xl mx-auto hidden animate-fade-in py-6">
                <h2 class="text-3xl font-bold text-slate-900 mb-6">Analytics & History</h2>
                
                <!-- Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-sm font-medium text-slate-500 uppercase">Total Spent</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-2" id="stat-total-spent">0.000 ETH</h3>
                    </div>
                     <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-sm font-medium text-slate-500 uppercase">Input Files</p>
                        <h3 class="text-3xl font-bold text-slate-900 mt-2" id="stat-total-files">--</h3>
                    </div>
                     <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-sm font-medium text-slate-500 uppercase">Most Used Agent</p>
                        <h3 class="text-3xl font-bold text-indigo-600 mt-2" id="stat-top-agent">--</h3>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-6">Spending Trend (7 Days)</h4>
                        <canvas id="chartSpending"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-6">Service Distribution</h4>
                        <canvas id="chartServices"></canvas>
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Agent</th>
                                <th class="px-6 py-4">Input</th>
                                <th class="px-6 py-4">Cost</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-100 text-sm text-slate-700">
                             <!-- Rows by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-msg">Notification</p>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let currentGhType = 'summary';
    let selectedAudioFile = null;

    function switchView(viewName) {
        ['home', 'github', 'audio', 'results', 'history'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('hidden');
        });
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-slate-50', 'text-indigo-600'));
        if(viewName === 'home') document.getElementById('nav-home').classList.add('active');
        if(viewName === 'history') {
            document.getElementById('nav-history').classList.add('active');
            loadHistoryData();
        }
    }

    function openGithubForm() { switchView('github'); }
    function openAudioForm() { switchView('audio'); }

    function selectGhType(btn, type) {
        document.querySelectorAll('.gh-type-btn').forEach(b => {
            b.classList.remove('active', 'border-indigo-500', 'bg-indigo-50', 'text-indigo-700');
            b.classList.add('border-slate-200', 'text-slate-600');
        });
        btn.classList.add('active', 'border-indigo-500', 'bg-indigo-50', 'text-indigo-700');
        btn.classList.remove('border-slate-200', 'text-slate-600');
        currentGhType = type;
    }

    // --- FILE UPLOAD HANDLING ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('audioFileInput');
    const fileNameDisplay = document.getElementById('file-name-display');
    const btnAudio = document.getElementById('btn-run-audio');

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-slate-50'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-slate-50'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('bg-slate-50');
        handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if(file && file.type.startsWith('audio/')) {
            selectedAudioFile = file;
            fileNameDisplay.innerText = "Selected: " + file.name;
            fileNameDisplay.classList.remove('hidden');
            btnAudio.disabled = false;
        } else {
            showToast("Please select a valid audio file.");
        }
    }

    // --- WALLET & PAYMENT ---
    const SEPOLIA_CHAIN_ID = '0xaa36a7'; 
    const SEPOLIA_RPC_URL = 'https://ethereum-sepolia.publicnode.com';
    const PAYMENT_RECIPIENT = '0x9497FE4B4ECA41229b9337abAEbCC91eCc7be23B';
    const PAYMENT_AMOUNT = '0.001';

    async function ensureWallet() {
        if (!window.ethereum) throw new Error("MetaMask not found.");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        // Switch Net
        try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_CHAIN_ID }] });
        } catch (e) {
            if (e.code === 4902) {
                 await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{ 
                        chainId: SEPOLIA_CHAIN_ID, 
                        chainName: 'Sepolia Testnet',
                        rpcUrls: [SEPOLIA_RPC_URL],
                        nativeCurrency: { name: 'SepoliaETH', symbol: 'ETH', decimals: 18 }
                    }]
                });
            } else throw e;
        }
        return provider.getSigner();
    }

    async function processPayment(statusFn) {
        const signer = await ensureWallet();
        statusFn("Processing Payment...");
        const tx = await signer.sendTransaction({
            to: PAYMENT_RECIPIENT,
            value: ethers.utils.parseEther(PAYMENT_AMOUNT)
        });
        statusFn("Verifying Transaction...");
        await tx.wait();
        return tx.hash;
    }

    // --- ACTIONS ---

    async function runGithubAgent() {
        const url = document.getElementById('repoUrlInput').value;
        if (!url) return showToast("Enter a valid URL");
        
        setLoading(true, "Github Analysis Started");
        try {
            const hash = await processPayment((msg) => updateLoadingText(msg));
            updateLoadingText("Analyzing Repository...");
            
            const res = await fetch('/api/github/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ repo_url: url, tx_hash: hash, agent_type: currentGhType })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error);

            showResults(data.summary);
        } catch (e) {
            showToast(e.message);
        } finally {
            setLoading(false);
        }
    }

    async function runAudioAgent() {
        if (!selectedAudioFile) return;
        
        setLoading(true, "Audio Analysis Started...");
        try {
            const hash = await processPayment((msg) => updateLoadingText(msg));
            updateLoadingText("Transcribing & Diarizing...");
            
            const formData = new FormData();
            formData.append('audio_file', selectedAudioFile);
            formData.append('tx_hash', hash);
            
            const res = await fetch('/api/audio/', {
                method: 'POST',
                 headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error);
            
            showAudioResults(data);

        } catch (e) {
            showToast(e.message);
        } finally {
            setLoading(false);
        }
    }
    
    // --- UI HELPERS ---

    function setLoading(on, text="Processing") {
        const el = document.getElementById('loading-overlay');
        const txt = document.getElementById('loading-text');
        if(on) { el.classList.remove('hidden'); txt.innerText = text; }
        else { el.classList.add('hidden'); }
    }
    
    function updateLoadingText(t) { document.getElementById('loading-text').innerText = t; }

    function showResults(contentHTML) {
        // Generic Result View (GitHub)
        document.getElementById('results-container').innerHTML = contentHTML;
        switchView('results');
    }

    function showAudioResults(data) {
        // Tabbed Audio View
        const tabsHtml = `
            <div class="border-b border-slate-200 mb-6 flex gap-4 overflow-x-auto">
                <button onclick="switchTab('summary')" class="tab-btn px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600" id="tab-summary">Summary</button>
                <button onclick="switchTab('transcript')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600" id="tab-transcript">Transcript</button>
                <button onclick="switchTab('minutes')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600" id="tab-minutes">Minutes</button>
                <button onclick="switchTab('action')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600" id="tab-action">Action Items</button>
            </div>
            
            <div id="content-summary" class="tab-content animate-fade-in block">
               ${data.summary ? data.summary : '<p>No summary available.</p>'}
            </div>

            <div id="content-transcript" class="tab-content hidden animate-fade-in">
                <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                    ${renderTranscript(data.utterances, data.transcript)}
                </div>
            </div>

            <div id="content-minutes" class="tab-content hidden animate-fade-in">
               ${data.minutes ? data.minutes : '<p>No minutes available.</p>'}
            </div>

            <div id="content-action" class="tab-content hidden animate-fade-in space-y-6">
                <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                    <h3 class="font-bold text-green-900 mb-4 flex items-center gap-2">‚úÖ To-Dos</h3>
                    ${data.todos || 'None'}
                </div>
                <div class="bg-red-50 p-6 rounded-xl border border-red-100">
                    <h3 class="font-bold text-red-900 mb-4 flex items-center gap-2">üìÖ Deadlines</h3>
                    ${data.deadlines || 'None'}
                </div>
            </div>
        `;
        document.getElementById('results-container').innerHTML = tabsHtml;
        switchView('results');
    }

    // Assign to window for onclick access
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
            el.classList.add('text-slate-500', 'font-medium');
        });

        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        const btn = document.getElementById(`tab-${tabName}`);
        btn.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
        btn.classList.remove('text-slate-500', 'font-medium');
    }

    function renderTranscript(utterances, fallbackText) {
        if (!utterances || utterances.length === 0) {
            return `<p class="text-slate-600">${fallbackText || 'No transcript available.'}</p>`;
        }
        
        return utterances.map((u, i) => {
             // Assign a color based on speaker ID character code to differentiate
             const spk = u.speaker || "Unknown";
             const colorClass = String(spk).charCodeAt(0) % 2 === 0 ? "bg-indigo-50 text-indigo-900" : "bg-white border border-slate-200 text-slate-900";
             const align = String(spk).charCodeAt(0) % 2 === 0 ? "ml-auto" : "mr-auto";
             
             return `
                <div class="flex flex-col ${align} max-w-[80%] mb-4">
                    <span class="text-xs font-bold text-slate-500 mb-1 px-1">${spk}</span>
                    <div class="${colorClass} p-3 rounded-2xl rounded-tl-none shadow-sm text-sm">
                        ${u.text}
                    </div>
                </div>
             `;
        }).join('');
    }

    function showToast(msg) {
        const el = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        el.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 3000);
    }

    function getCookie(name) {
        if (!document.cookie) return null;
        const xsrf = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return xsrf ? decodeURIComponent(xsrf.split('=')[1]) : null;
    }

    // --- HISTORY & CHARTS ---
    let chartInstance1, chartInstance2;

    async function loadHistoryData() {
        const res = await fetch('/api/stats/');
        if(!res.ok) return;
        const data = await res.json();

        // 1. Stats
        document.getElementById('stat-total-spent').innerText = data.total_spent + " ETH";
        document.getElementById('stat-total-files').innerText = data.history.length;
        
        // 2. Table
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = data.history.map(item => `
            <tr class="hover:bg-slate-50 transition">
                <td class="px-6 py-4 text-slate-500">${item.date}</td>
                 <td class="px-6 py-4"><span class="bg-indigo-50 text-indigo-700 font-bold px-2 py-1 rounded text-xs border border-indigo-100">${item.agent}</span></td>
                <td class="px-6 py-4 font-mono text-xs text-slate-500 truncate max-w-[200px]" title="${item.input}">${item.input}</td>
                <td class="px-6 py-4 font-medium text-slate-900">${item.cost} ETH</td>
                <td class="px-6 py-4"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">Success</span></td>
                <td class="px-6 py-4 text-right">
                    <button onclick="viewHistoryItem(${item.id})" class="text-indigo-600 hover:text-indigo-800 font-bold text-sm bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded transition">View</button>
                </td>
            </tr>
        `).join('');

        // 3. Charts
        initCharts(data.spending, data.services);
    }

    // Handle View History Logic
    window.viewHistoryItem = async function(id) {
        setLoading(true, "Fetching Details...");
        try {
            const res = await fetch(`/api/tx/${id}/`);
            if(!res.ok) throw new Error("Failed to load details");
            const data = await res.json();
            
            if(data.category === 'AUDIO') {
                showAudioResults(data.output);
            } else {
                showResults(data.output.summary || JSON.stringify(data.output));
            }
        } catch(e) {
            showToast("Error: " + e.message);
        } finally {
            setLoading(false);
        }
    }

    function initCharts(spendingData, servicesData) {
        const ctx1 = document.getElementById('chartSpending').getContext('2d');
        const ctx2 = document.getElementById('chartServices').getContext('2d');

        if(chartInstance1) chartInstance1.destroy();
        if(chartInstance2) chartInstance2.destroy();

        chartInstance1 = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: Object.keys(spendingData),
                datasets: [{
                    label: 'ETH Spent',
                    data: Object.values(spendingData),
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        chartInstance2 = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(servicesData),
                datasets: [{
                    data: Object.values(servicesData),
                    backgroundColor: ['#4F46E5', '#8B5CF6']
                }]
            },
            options: { cutout: '70%' }
        });
    }

    // Init Balance
    (async () => {
        try {
            if(window.ethereum) {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const bal = await provider.getBalance((await provider.listAccounts())[0]);
                document.getElementById('balanceDisplay').innerText = parseFloat(ethers.utils.formatEther(bal)).toFixed(4) + " ETH";
            }
        } catch(e) {}
    })();

</script>
</body>
</html>