<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RepoSage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">R</div>
            <span class="text-xl font-bold text-slate-900">RepoSage</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col text-right">
                <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Connected Wallet</span>
                <span class="text-sm font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded">{{ user.wallet_address }}</span>
            </div>
            <div class="text-right">
                <span id="balanceDisplay" class="text-sm font-bold text-indigo-600">Loading Balance...</span>
            </div>
            <a href="{% url 'logout' %}" class="ml-4 px-4 py-2 border border-red-200 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition">
                Logout
            </a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto mt-10 p-6">
        
        <!-- URL Input Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 mb-8 sticky top-4 z-10">
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Target Repository</h2>
            <p class="text-slate-500 mb-6">Enter the GitHub URL you want to analyze.</p>
            
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="repoUrl" 
                    placeholder="https://github.com/owner/repository" 
                    required
                    class="flex-1 px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition w-full"
                >
            </div>
            <div id="formError" class="text-red-500 text-sm mt-3 hidden"></div>
        </div>

        <!-- Agents Grid -->
        <h3 class="text-xl font-bold text-slate-800 mb-4 px-1">Select an AI Agent</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            
            <!-- 1. Setup Runner -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="setup_runner">
                <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-4 text-xl">üöÄ</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-indigo-600">Setup Runner</h4>
                <p class="text-sm text-slate-500 mb-4">Extracts installation and run steps from README to get you started cleanly.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

            <!-- 2. Architecture Map -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="architecture">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mb-4 text-xl">üèóÔ∏è</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-blue-600">Architecture Map</h4>
                <p class="text-sm text-slate-500 mb-4">Maps out the project structure, key modules, and data flow.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

            <!-- 3. Contributing Guide -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="contributing">
                <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mb-4 text-xl">ü§ù</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-green-600">Contributing Guide</h4>
                <p class="text-sm text-slate-500 mb-4">Explains how to open PRs, branch naming, and testing standards.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

             <!-- 4. Issue Triage -->
             <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="issues">
                <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center mb-4 text-xl">üêû</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-orange-600">Issue Triage</h4>
                <p class="text-sm text-slate-500 mb-4">Groups open issues into 'Good First Issue', 'Bugs', and 'Features'.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

            <!-- 5. PR Reviewer -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="pr_review">
                <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center mb-4 text-xl">üßê</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-purple-600">PR Reviewer</h4>
                <p class="text-sm text-slate-500 mb-4">Reviews the latest PR for code quality, risks, and suggestions.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

            <!-- 6. Release Notes -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="release_notes">
                <div class="w-10 h-10 bg-pink-100 text-pink-600 rounded-lg flex items-center justify-center mb-4 text-xl">üìù</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-pink-600">Release Notes</h4>
                <p class="text-sm text-slate-500 mb-4">Summarizes recent releases and identifies breaking changes.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

            <!-- 7. Dependency Risk -->
            <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="dependencies">
                <div class="w-10 h-10 bg-red-100 text-red-600 rounded-lg flex items-center justify-center mb-4 text-xl">üõ°Ô∏è</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-red-600">Dependency Risk</h4>
                <p class="text-sm text-slate-500 mb-4">Scans dependencies for outdated packages and potential risks.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

             <!-- 8. License & Usage -->
             <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="license">
                <div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-lg flex items-center justify-center mb-4 text-xl">‚öñÔ∏è</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-yellow-600">License & Usage</h4>
                <p class="text-sm text-slate-500 mb-4">Checks if you can use this repo commercially and explains limits.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>
            
            <!-- Default / Base (Hidden/Included as fallback or separate card if needed, but Setup Runner covers mostly) -->
             <div class="agent-card bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md cursor-pointer transition group" data-agent="summary">
                <div class="w-10 h-10 bg-slate-100 text-slate-600 rounded-lg flex items-center justify-center mb-4 text-xl">üìÑ</div>
                <h4 class="font-bold text-lg mb-2 group-hover:text-indigo-600">General Summary</h4>
                <p class="text-sm text-slate-500 mb-4">The classic overview of the project, features, and stack.</p>
                <span class="text-xs font-semibold bg-slate-100 px-2 py-1 rounded text-slate-600">0.001 ETH</span>
            </div>

        </div>

        <div class="text-center mb-8">
            <button 
                id="generateBtn"
                disabled
                class="px-10 py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-3 mx-auto text-lg"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span id="btnText">Select an Agent to Run</span>
            </button>
        </div>

        <div id="loadingState" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-slate-700">Initializing Agent...</h3>
            <p class="text-slate-500">Connecting to Sepolia network.</p>
        </div>

        <div id="resultSection" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
            <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-bold text-slate-900">Analysis Result</h3>
                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">Success</span>
            </div>
            
            <div id="summaryContent" class="prose prose-indigo max-w-none text-slate-700">
            </div>
        </div>

    </main>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Reload page on network change to avoid state inconsistencies
    if (window.ethereum) {
        window.ethereum.on('chainChanged', () => {
            window.location.reload();
        });
    }

    const SEPOLIA_CHAIN_ID = '0xaa36a7'; // 11155111
    const SEPOLIA_RPC_URL = 'https://ethereum-sepolia.publicnode.com';
    const PAYMENT_RECIPIENT = '0x9497FE4B4ECA41229b9337abAEbCC91eCc7be23B';
    const PAYMENT_AMOUNT = '0.001';
    let selectedAgent = null;

    // 1. Fetch Wallet Balance
    async function loadWalletData() {
        if (typeof window.ethereum !== 'undefined') {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            
            try {
                const accounts = await provider.listAccounts();
                if (accounts.length === 0) return;
                
                const address = accounts[0];
                const balance = await provider.getBalance(address);
                const ethBalance = ethers.utils.formatEther(balance);
                
                document.getElementById('balanceDisplay').innerText = parseFloat(ethBalance).toFixed(4) + ' SepoliaETH';
            } catch (err) {
                console.error("Balance Error:", err);
                document.getElementById('balanceDisplay').innerText = "Err";
            }
        }
    }
    loadWalletData();

    async function switchNetwork() {
        if (!window.ethereum) return;
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: SEPOLIA_CHAIN_ID }],
            });
        } catch (switchError) {
            // This error code indicates that the chain has not been added to MetaMask.
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [
                            {
                                chainId: SEPOLIA_CHAIN_ID,
                                chainName: 'Sepolia Testnet',
                                rpcUrls: [SEPOLIA_RPC_URL],
                                nativeCurrency: {
                                    name: 'SepoliaETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                blockExplorerUrls: ['https://sepolia.etherscan.io/']
                            },
                        ],
                    });
                } catch (addError) {
                    console.error("Failed to add Sepolia network", addError);
                    throw new Error("Failed to add Sepolia Testnet. Please add it manually.");
                }
            } else {
                throw switchError;
            }
        }
    }

    // Agent Selection Logic
    document.querySelectorAll('.agent-card').forEach(card => {
        card.addEventListener('click', () => {
            // Remove active class from all
            document.querySelectorAll('.agent-card').forEach(c => {
                c.classList.remove('ring-2', 'ring-indigo-600', 'bg-indigo-50');
            });
            
            // Add active class to clicked
            card.classList.add('ring-2', 'ring-indigo-600', 'bg-indigo-50');
            
            selectedAgent = card.dataset.agent;
            
            // Enable button
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            document.getElementById('btnText').innerText = `Pay 0.001 ETH & Run ${card.querySelector('h4').innerText}`;
        });
    });


    // 2. Handle Agent Execution
    document.getElementById('generateBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        
        const repoUrl = document.getElementById('repoUrl').value.trim();
        const generateBtn = document.getElementById('generateBtn');
        const loadingState = document.getElementById('loadingState');
        const resultSection = document.getElementById('resultSection');
        const summaryContent = document.getElementById('summaryContent');
        const formError = document.getElementById('formError');
        const statusText = loadingState.querySelector('h3');
        const statusDesc = loadingState.querySelector('p');

        // Reset UI
        formError.classList.add('hidden');
        resultSection.classList.add('hidden');
        
        // Step 0: Validation
        if (!repoUrl) {
            formError.innerText = "Please enter a valid GitHub Repository URL.";
            formError.classList.remove('hidden');
            window.scrollTo(0,0);
            return;
        }
        
        if (!selectedAgent) {
             formError.innerText = "Please select an Agent to run from the grid.";
            formError.classList.remove('hidden');
            return;
        }

        loadingState.classList.remove('hidden');
        generateBtn.disabled = true;
        generateBtn.classList.add('opacity-75');
        
        // Step 1: Check Wallet
        if (typeof window.ethereum === 'undefined') {
            formError.innerText = "Please install MetaMask to make payments.";
            formError.classList.remove('hidden');
            loadingState.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-75');
            return;
        }

        try {
            // Step 1: Switch to Sepolia (if needed)
            statusText.innerText = "Switching Network...";
            statusDesc.innerText = "Please confirm network switch to Sepolia Testnet.";
            await switchNetwork();

            // Re-initialize provider after switch to ensure it picks up the new chain
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();

            // Balance Check
            const balance = await signer.getBalance();
            const requiredAmount = ethers.utils.parseEther(PAYMENT_AMOUNT);
            
            // Add a small buffer for gas
            if (balance.lt(requiredAmount)) {
                throw new Error("Insufficient SepoliaETH balance. You need at least 0.001 ETH.");
            }

            // Step 2: Send Payment
            statusText.innerText = "Processing Payment...";
            statusDesc.innerText = `Sending ${PAYMENT_AMOUNT} ETH to authorize analysis...`;

            const tx = await signer.sendTransaction({
                to: PAYMENT_RECIPIENT,
                value: requiredAmount
            });

            statusDesc.innerText = "Waiting for transaction confirmation...";
            const receipt = await tx.wait(); // Wait for 1 confirmation
            console.log("Tx Confirmed:", receipt.transactionHash);

            // Step 3: Call Backend with Hash
            statusText.innerText = "Verifying & Analyzing...";
            statusDesc.innerText = "Payment confirmed on chain. Generating summary (this may take 20s)...";

            // CALL DJANGO BACKEND
            const response = await fetch('/api/summarize/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') 
                },
                body: JSON.stringify({ 
                    repo_url: repoUrl,
                    tx_hash: tx.hash,
                    agent_type: selectedAgent
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate summary');
            }
            
            // Inject HTML directly from Gemini
            summaryContent.innerHTML = data.summary;
            
            loadingState.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error(error);
            loadingState.classList.add('hidden');
            
            // Nice error message handling
            let msg = error.message;
            if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
                msg = "Transaction rejected by user.";
            } else if (msg.includes("insufficient funds")) {
                msg = "Insufficient SepoliaETH balance.";
            }

            formError.innerText = msg;
            formError.classList.remove('hidden');
            window.scrollTo(0,0);
        } finally {
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-75');
            
            // Reset text
            statusText.innerText = "Analyzing Repository..."; 
            statusDesc.innerText = "Fetching metadata and generating summary.";
        }
    });
</script>
</body>
</html>