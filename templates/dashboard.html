<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RepoSage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">R</div>
            <span class="text-xl font-bold text-slate-900">RepoSage</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col text-right">
                <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Connected Wallet</span>
                <span class="text-sm font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded">{{ user.wallet_address }}</span>
            </div>
            <div class="text-right">
                <span id="balanceDisplay" class="text-sm font-bold text-indigo-600">Loading Balance...</span>
            </div>
            <a href="{% url 'logout' %}" class="ml-4 px-4 py-2 border border-red-200 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition">
                Logout
            </a>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto mt-10 p-6">
        
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 mb-8">
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Generate Repo Summary</h2>
            <p class="text-slate-500 mb-6">Enter a public GitHub URL to get an AI-powered breakdown.</p>
            
            <form id="agentForm" class="flex flex-col md:flex-row gap-4">
                {% csrf_token %}
                <input 
                    type="url" 
                    id="repoUrl" 
                    placeholder="https://github.com/owner/repository" 
                    required
                    class="flex-1 px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition"
                >
                <button 
                    type="submit" 
                    id="generateBtn"
                    class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center gap-2"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    Run Agent
                </button>
            </form>
            <div id="formError" class="text-red-500 text-sm mt-3 hidden"></div>
        </div>

        <div id="loadingState" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-slate-700">Analyzing Repository...</h3>
            <p class="text-slate-500">Fetching metadata and generating summary.</p>
        </div>

        <div id="resultSection" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
            <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-bold text-slate-900">Analysis Result</h3>
                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">Success</span>
            </div>
            
            <div id="summaryContent" class="prose prose-indigo max-w-none text-slate-700">
                </div>
        </div>

    </main>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // 1. Fetch Wallet Balance
    async function loadWalletData() {
        if (typeof window.ethereum !== 'undefined') {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            
            try {
                const accounts = await provider.listAccounts();
                if (accounts.length === 0) return;
                
                const address = accounts[0];
                const balance = await provider.getBalance(address);
                const ethBalance = ethers.utils.formatEther(balance);
                
                document.getElementById('balanceDisplay').innerText = parseFloat(ethBalance).toFixed(4) + ' ETH';
            } catch (err) {
                console.error("Balance Error:", err);
                document.getElementById('balanceDisplay').innerText = "Err";
            }
        }
    }
    loadWalletData();

    // 2. Handle Agent Form Submission
    document.getElementById('agentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const repoUrl = document.getElementById('repoUrl').value;
        const generateBtn = document.getElementById('generateBtn');
        const loadingState = document.getElementById('loadingState');
        const resultSection = document.getElementById('resultSection');
        const summaryContent = document.getElementById('summaryContent');
        const formError = document.getElementById('formError');

        // Reset UI
        formError.classList.add('hidden');
        resultSection.classList.add('hidden');
        loadingState.classList.remove('hidden');
        generateBtn.disabled = true;
        generateBtn.classList.add('opacity-75');

        try {
            // CALL DJANGO BACKEND
            const response = await fetch('/api/summarize/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Ensure getCookie function is available
                },
                body: JSON.stringify({ repo_url: repoUrl })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate summary');
            }
            
            // Inject HTML directly from Gemini
            summaryContent.innerHTML = data.summary;
            
            loadingState.classList.add('hidden');
            resultSection.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            loadingState.classList.add('hidden');
            formError.innerText = error.message;
            formError.classList.remove('hidden');
        } finally {
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-75');
        }
    });
</script>
</body>
</html>