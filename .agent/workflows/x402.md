---
description: How to implement x402 Payment Protocol for new AI Agents
---

# x402 Protocol Workflow

## Overview

This workflow explains how to add the **x402 Payment Required Protocol** to a new AI Agent endpoint.

---

## What is x402?

x402 uses HTTP status code **402 (Payment Required)** to enable pay-per-API-call using cryptocurrency.

### Flow Diagram

```
User ‚Üí Frontend ‚Üí Backend (402) ‚Üí Frontend ‚Üí MetaMask ‚Üí Backend (Success)
```

---

## Step 1: Create the Backend Endpoint

**File:** `agents/views.py`

Add a new x402-enabled view function:

```python
@login_required  # User must be logged in
@require_POST    # Only POST requests allowed
@x402_payment_required(
    required_amount=0.0001,       # Price in MON
    asset="MON",                  # Currency
    description="My New Agent"   # Display name
)
def run_my_agent_x402(request):
    """
    My new x402-enabled agent.
    This function only runs AFTER payment is verified.
    """
    log_agent("MY_AGENT", f"User: {request.user.wallet_address}")
    log_success("x402 Payment Verified - Processing...")
    
    try:
        # Parse request body
        data = json.loads(request.body)
        input_param = data.get('param')
        
        if not input_param:
            return JsonResponse({'error': 'Missing param'}, status=400)
        
        # Your agent logic here
        result = do_something(input_param)
        
        # Save to database (optional)
        payment_header = request.headers.get('x-payment', 'x402')
        AnalysisTransaction.objects.create(
            user=request.user,
            category='MY_AGENT',
            agent_type='my_type',
            input_text=input_param,
            output_data=json.dumps(result),
            tx_hash=payment_header[:66],
            cost=0.0001
        )
        
        log_success("Agent complete!")
        return JsonResponse(result)
        
    except Exception as e:
        log_error(f"Error: {e}")
        return JsonResponse({'error': str(e)}, status=500)
```

---

## Step 2: Add URL Route

**File:** `agents/urls.py`

Add the URL pattern:

```python
# In urlpatterns list
path('x402/my-agent/', views.run_my_agent_x402, name='run_my_agent_x402'),
```

---

## Step 3: Add Frontend Function

**File:** `templates/dashboard.html`

Add a function to call your agent:

```javascript
// Inside the main <script> tag

async function runMyAgent() {
    const param = document.getElementById('myInput').value;
    if (!param) return showToast("Enter a value");
    
    console.log(`ü§ñ [MY_AGENT] Starting...`);
    
    setLoading(true, "Initializing x402 Agent");
    
    try {
        updateLoadingText("üî∑ Requesting API (x402 Flow)...");
        
        // Use x402Fetch - it handles 402 automatically!
        const res = await window.x402Fetch('/api/x402/my-agent/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ param: param })
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        console.log(`‚úÖ [MY_AGENT] Complete!`);
        
        // Display results
        showResults(data);
        
    } catch (e) {
        console.error(`‚ùå [MY_AGENT] Error:`, e);
        showToast(e.message);
    } finally {
        setLoading(false);
    }
}
```

---

## Step 4: Add UI (Optional)

Add a card and form for your agent in the dashboard HTML.

---

## Key Files Summary

| File | Purpose |
|------|---------|
| `agents/views.py` | Backend logic with @x402_payment_required |
| `agents/urls.py` | URL routing |
| `templates/dashboard.html` | Frontend with x402Fetch |
| `agents/models.py` | Database storage |

---

## Decorator Reference

```python
@x402_payment_required(
    required_amount=0.0001,   # float - Amount in MON
    asset="MON",              # string - Currency symbol
    description="My API"      # string - Display name
)
```

**What it does:**
1. Checks for `x-payment` header
2. If missing ‚Üí Returns HTTP 402 with payment requirements
3. If present ‚Üí Allows function to execute

---

## Testing

1. Restart Django server
2. Navigate to your agent in the dashboard
3. Click execute button
4. Watch for 402 response in browser console
5. Approve MetaMask transaction
6. Verify retry with x-payment header
7. Check results

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| 402 not returned | Check decorator is applied |
| MetaMask not opening | Check window.ethereum exists |
| Retry failing | Check CSRF token is included |
| Payment not saving | Check tx_hash extraction |
